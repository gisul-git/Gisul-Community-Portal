# ===========================================================
#  GisulMatch Celery Worker Dockerfile (with FAISS support)
# ===========================================================
FROM python:3.12-slim

# Install system dependencies for conversions/OCR
# Combined in single layer and cleaned up immediately to reduce image size
RUN apt-get update && apt-get install -y --no-install-recommends \
    libreoffice \
    poppler-utils \
    tesseract-ocr \
    tesseract-ocr-eng \
    antiword \
    fonts-dejavu-core \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && rm -rf /tmp/* /var/tmp/*

# Set workdir early
WORKDIR /app

# Upgrade pip first (cached separately from requirements)
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Copy only requirements first for better layer caching
# Use docker-optimized requirements (excludes torch/sentence-transformers)
COPY ./backend/requirements-docker.txt /app/requirements.txt

# Install Python dependencies
# torch and sentence-transformers are excluded (not needed for OpenAI embeddings)
# This reduces image size from ~13GB to ~1.5GB
RUN pip install --no-cache-dir -r requirements.txt

# Copy backend source (changes most frequently)
COPY ./backend /app

# Environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    CELERY_BROKER_URL=redis://redis:6379/0 \
    CELERY_RESULT_BACKEND=redis://redis:6379/0 \
    REDIS_URL=redis://redis:6379/0

CMD ["celery", "-A", "tasks.celery_app:cel", "worker", "--loglevel=INFO", "--concurrency=4"]
