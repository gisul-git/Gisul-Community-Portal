server {
    listen 80;
    server_name community.gisul.co.in;
    root /usr/share/nginx/html;
    
    # Allow larger request bodies for POST requests (analytics, uploads, etc.)
    client_max_body_size 100M;
    client_body_buffer_size 128k;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Named location for backend errors - returns JSON instead of HTML
    location @backend_error {
        default_type application/json;
        return 502 '{"detail":"Backend unavailable"}';
    }

    # API proxy - forward API requests to backend service
    location /api/ {
        proxy_pass http://backend:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    # CRITICAL: /tasks route - MUST use ^~ for highest priority to prevent HTML fallback
    # ^~ modifier ensures this prefix location takes precedence over ALL regex locations and location /
    # This location MUST be placed BEFORE location / to prevent fallback to index.html
    # Handles: /tasks, /tasks/, /tasks/<id>, /tasks/<id>/
    location ^~ /tasks {
        # Proxy to backend - use proxy_pass WITHOUT URI to preserve full request URI
        # When proxy_pass has NO URI path, nginx appends the full request URI
        # Request: /tasks/123 -> http://backend:8000/tasks/123 ✓
        # Request: /tasks -> http://backend:8000/tasks ✓
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        # CRITICAL: Disable redirect following to prevent redirect loops
        proxy_redirect off;
        proxy_intercept_errors on;
        error_page 502 503 504 = @backend_error;
    }

    # Backend API endpoints - explicit prefix matching
    # These must be before the catch-all location / block
    # Use regex to match only backend API endpoints, not frontend routes like /admin/dashboard
    # This ensures /admin/dashboard falls through to the SPA fallback (location /)
    location ~ ^/admin/(search_by_text|search_by_jd|search_by_awa|upload_jd|bulk_upload_start|trainers_list|trainers|trainer|export_trainers_to_excel|vector_integrity|repair_vectors|clear_caches|activity_logs|requirements|approve_requirement) {
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    location /trainer/ {
        proxy_pass http://backend:8000/trainer/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    # Customer API endpoints - explicit regex pattern (excludes dashboard)
    # This ensures /customer/dashboard falls through to the SPA fallback (location /)
    location ~ ^/customer/(profile|trainers_list|post_requirement|requirements|search_by_text|search_by_jd|upload_jd) {
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    location /api/auth/ {
        proxy_pass http://backend:8000/api/auth/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    # CRITICAL: Exact match for /analytics/query - MUST handle POST requests
    # This location has higher priority than prefix locations
    # Place BEFORE location ^~ /analytics/ to ensure POST requests work
    location = /analytics/query {
        # Proxy to backend - use proxy_pass WITHOUT URI to preserve full request URI
        # When proxy_pass has NO URI path, nginx appends the full request URI
        # Request: /analytics/query -> http://backend:8000/analytics/query ✓
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors on;
        error_page 502 503 504 = @backend_error;
        
        # Handle CORS preflight OPTIONS requests
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
            add_header Access-Control-Max-Age 1728000 always;
            add_header Content-Type 'text/plain; charset=utf-8' always;
            add_header Content-Length 0 always;
            return 204;
        }
    }
    
    # Proxy analytics routes - MUST use ^~ for highest priority to prevent HTML fallback
    # ^~ modifier ensures this prefix location takes precedence over ALL regex locations and location /
    # This location MUST be placed BEFORE location / to prevent fallback to index.html
    location ^~ /analytics/ {
        # Proxy to backend - preserve full request URI
        # Request: /analytics/query -> Backend: http://backend:8000/analytics/query
        # Request: /analytics/... -> Backend: http://backend:8000/analytics/...
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors on;
        error_page 502 503 504 = @backend_error;
    }

    location /log_activity {
        proxy_pass http://backend:8000/log_activity;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_intercept_errors off;
        error_page 502 503 504 = @backend_error;
    }

    # Proxy docs and OpenAPI
    location /docs {
        proxy_pass http://backend:8000/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /openapi.json {
        proxy_pass http://backend:8000/openapi.json;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Main location - serve frontend static files (MUST be last)
    # SPA fallback: serve index.html for all non-API routes
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Content-Type "text/html";
    }
}

